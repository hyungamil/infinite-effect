<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë¬´í•œì˜ ê³„ë‹¨: ì´ˆê³ ìˆ˜ ë¹„ë°€ í›ˆë ¨ì†Œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #1a202c;
            color: #e2e8f0;
            font-family: 'Black Han Sans', sans-serif;
            overflow: hidden;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
            margin: 0;
            padding: 0;
        }
        #game-container {
            position: relative;
            width: 100%;
            height: 100vh;
            height: 100dvh; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(to bottom, #cfd9df 0%, #e2ebf0 100%);
            transition: filter 1s ease;
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            image-rendering: pixelated; 
            transition: transform 0.1s;
        }
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            z-index: 10;
        }
        .interactive {
            pointer-events: auto;
        }
        
        /* íŒ¨ë„ ìŠ¤íƒ€ì¼ */
        .military-panel {
            background: rgba(20, 25, 30, 0.95);
            border: 2px solid #4a5568;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5), inset 0 0 20px rgba(0,0,0,0.8);
            position: relative;
        }
        .military-panel-red {
            background: rgba(40, 10, 10, 0.95);
            border: 2px solid #c53030;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.3), inset 0 0 20px rgba(100, 0, 0, 0.8);
        }
        .military-panel-purple {
            background: rgba(20, 0, 20, 0.95);
            border: 2px solid #9f7aea;
            box-shadow: 0 0 30px rgba(128, 0, 128, 0.4), inset 0 0 20px rgba(50, 0, 50, 0.8);
        }
        .military-panel-gold {
            background: rgba(40, 30, 10, 0.95);
            border: 2px solid #ecc94b;
            box-shadow: 0 0 30px rgba(236, 201, 75, 0.4), inset 0 0 20px rgba(100, 80, 20, 0.8);
        }
        
        /* ì¸ê²Œì„ ë¯¸ë‹ˆ ë­í‚¹ */
        .ingame-rank-panel {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #4a5568;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            width: 140px;
        }
        
        .hud-text {
            font-family: 'Share Tech Mono', monospace;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
        }

        /* ì»¨íŠ¸ë¡¤ ë²„íŠ¼ */
        .controls {
            display: flex;
            width: 100%;
            height: 25vh;
            pointer-events: auto;
            z-index: 20;
            background: rgba(0,0,0,0.85);
            border-top: 4px solid #2d3748;
            padding-bottom: env(safe-area-inset-bottom);
            transition: background 0.3s;
        }
        .control-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #a0aec0;
            user-select: none;
            transition: all 0.1s;
            text-transform: uppercase;
            font-family: 'Black Han Sans', sans-serif;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        .control-btn:active {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .control-btn span.icon {
            font-size: 3rem;
            margin-bottom: 8px;
            display: block;
        }
        .btn-turn { 
            background: linear-gradient(180deg, #2d3748 0%, #1a202c 100%);
            border-right: 2px solid #000;
        }
        .btn-climb { 
            background: linear-gradient(180deg, #4a5568 0%, #2d3748 100%);
        }

        .hidden { display: none !important; }

        #snow-canvas {
            z-index: 5;
            pointer-events: none;
        }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes blink-red {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .warning-blink { animation: blink-red 1s infinite; color: #fc8181; }
        .hell-blink { animation: blink-red 0.5s infinite; color: #d6bcfa; }
        .input-error { animation: shake 0.3s ease-in-out; border-bottom-color: #fc8181 !important; }
        
        .whiteout-effect #gameCanvas { filter: brightness(1.2) contrast(0.8) blur(0.5px); }
        
        #shuffleAlert {
            position: absolute;
            bottom: 28vh;
            left: 50%;
            transform: translateX(-50%);
            color: #f6ad55;
            font-size: 1.5rem;
            text-shadow: 2px 2px 0px #000;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            z-index: 30;
            width: 100%;
            text-align: center;
        }
        
        #secretTrigger { cursor: default; user-select: none; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <canvas id="snow-canvas"></canvas>

    <!-- UI ë ˆì´ì–´ -->
    <div class="ui-layer">
        <!-- ìƒë‹¨ ì •ë³´ -->
        <div class="p-4 w-full flex justify-between items-start">
            <div class="military-panel p-3 rounded w-32 interactive cursor-pointer hover:bg-gray-800 transition">
                <div id="secretTrigger" class="text-xs text-green-500 uppercase tracking-wider mb-1">ì ìˆ˜ (Score)</div>
                <div id="scoreDisplay" class="text-3xl text-white hud-text text-right transition-colors duration-200">0</div>
            </div>
            
            <div id="statusPanel" class="military-panel p-2 rounded px-4 hidden md:block">
                <div id="statusText" class="text-xs text-green-400 font-mono tracking-widest">ì •ìƒ ëª¨ë“œ</div>
            </div>

            <div class="ingame-rank-panel">
                <div class="text-xs text-yellow-500 font-bold mb-1 border-b border-gray-600 pb-1">âš¡ ì „íˆ¬ ìƒí™©íŒ</div>
                <div id="inGameRankList" class="space-y-1 font-mono text-gray-300">
                    <div class="text-center text-[10px]">ë¡œë”©ì¤‘...</div>
                </div>
            </div>
        </div>

        <!-- ì—°ë£Œ ê²Œì´ì§€ -->
        <div class="absolute top-28 left-1/2 transform -translate-x-1/2 w-64 md:w-80">
            <div class="flex justify-between text-xs text-gray-400 mb-1 font-bold shadow-black drop-shadow-md">
                <span>E</span>
                <span>ì—°ë£Œ (FUEL)</span>
                <span>F</span>
            </div>
            <div class="w-full h-4 bg-gray-800 border-2 border-gray-600 skew-x-[-15deg] overflow-hidden">
                <div id="energyBar" class="h-full bg-gradient-to-r from-yellow-600 to-yellow-400 w-full transition-all duration-100 origin-left"></div>
            </div>
        </div>

        <div id="shuffleAlert" class="font-bold">âš  ë²„íŠ¼ ì´ë™! âš </div>
        <div class="h-[25vh]"></div>
    </div>

    <!-- ì»¨íŠ¸ë¡¤ëŸ¬ -->
    <div class="controls fixed bottom-0 left-0 w-full">
        <div id="btnTurn" class="control-btn btn-turn">
            <span class="icon">â†º</span>
            <span>ë°©í–¥ì „í™˜ (Z)</span>
        </div>
        <div id="btnClimb" class="control-btn btn-climb">
            <span class="icon">â–²</span>
            <span>ì˜¤ë¥´ê¸° (X)</span>
        </div>
    </div>

    <!-- ì‹œì‘ í™”ë©´ -->
    <div id="startModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/85 backdrop-blur-sm interactive px-4">
        <div class="military-panel p-6 w-full max-w-sm text-center rounded-lg border-green-900/50 relative">
            <h1 class="text-4xl md:text-5xl mb-2 text-white drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)]" style="font-family: 'Black Han Sans'; letter-spacing: -1px;">ë¬´í•œì˜ ì „ì°¨<br><span class="text-2xl text-gray-400 font-normal tracking-widest">WINTER WAR</span></h1>
            
            <div class="bg-black/40 p-4 rounded mb-4 border border-gray-700">
                <p class="text-yellow-400 font-bold mb-2 text-lg">"ë¬´í•œì˜ ê³„ë‹¨ ê³ ìˆ˜ê°€ ë˜ëŠ” ë²•"</p>
                <p class="text-gray-300 text-sm leading-relaxed word-keep-all">
                    ì´ ë¹„ê¸‰ì„ ì „ìˆ˜ë°›ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?<br>
                    ê·¸ë ‡ë‹¤ë©´ í˜¹í•œì˜ ì „ì¥ì—ì„œ ì‚´ì•„ë‚¨ì•„<br>
                    ìê²©ì„ ì¦ëª…í•˜ì‹­ì‹œì˜¤.
                </p>
                <p class="text-red-400 mt-2 font-bold animate-pulse">ëª©í‘œ: 1000 í¬ì¸íŠ¸ ë‹¬ì„±</p>
            </div>
            
            <div class="mb-4 text-left bg-black/50 p-3 border border-gray-700">
                <p class="text-xs text-green-600 mb-1 font-mono">íŒŒì¼ëŸ¿ ì´ë¦„ (PILOT NAME) <span class="text-red-500">*</span></p>
                <input type="text" id="usernameInput" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="10" class="w-full bg-transparent text-white border-b border-green-700 focus:border-green-400 outline-none font-mono text-lg uppercase text-center transition-colors">
            </div>

            <div class="flex gap-2 mb-4">
                <button id="rankBtn" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded border border-gray-500 shadow-lg font-mono text-lg">
                    ğŸ† ë­í‚¹ ë³´ê¸°
                </button>
                <button id="startBtn" class="flex-1 bg-green-800 hover:bg-green-700 text-white font-bold py-3 rounded border-2 border-green-900 shadow-[0_0_15px_rgba(20,83,45,0.5)] transition font-mono tracking-widest text-lg">
                    ë¯¸ì…˜ ìˆ˜ë½
                </button>
            </div>
            
            <div class="text-xs text-gray-500 font-mono mb-6">
                [PC] Z: ë°©í–¥ì „í™˜ / X: ì˜¤ë¥´ê¸°<br>
                [Mobile] í•˜ë‹¨ ë²„íŠ¼ í„°ì¹˜
            </div>

            <div class="absolute bottom-2 right-4 text-xs text-gray-600 font-mono">
                ë§Œë“ ì‚¬ëŒ: í”¼ì•„ë…¸
            </div>
        </div>
    </div>

    <!-- ë­í‚¹ ëª¨ë‹¬ -->
    <div id="rankingModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md interactive px-4 hidden">
        <div class="military-panel p-6 w-full max-w-sm text-center rounded-lg border-blue-900/50 h-[60vh] flex flex-col">
            <h2 class="text-3xl text-blue-400 mb-4 font-black tracking-tighter">ëª…ì˜ˆì˜ ì „ë‹¹</h2>
            
            <div class="bg-black/40 rounded p-4 w-full flex-1 border border-gray-700 overflow-y-auto mb-4">
                <div class="flex justify-between text-xs text-gray-500 mb-2 border-b border-gray-800 pb-1 uppercase font-mono">
                    <span class="w-8">ìˆœìœ„</span>
                    <span class="flex-1 text-left px-2">ì´ë¦„</span>
                    <span class="w-16 text-right">ì ìˆ˜</span>
                </div>
                <div id="mainLeaderboardList" class="space-y-1 text-sm font-mono">
                    <div class="text-center text-gray-500 mt-10">ë°ì´í„° ë¡œë”© ì¤‘...</div>
                </div>
            </div>

            <button id="closeRankBtn" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded border border-gray-500 shadow-lg font-mono">
                ë‹«ê¸°
            </button>
        </div>
    </div>

    <!-- ê²½ê³  ëª¨ë‹¬ -->
    <div id="warningModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-red-900/40 backdrop-blur-sm interactive px-4 hidden">
        <div class="military-panel-red p-6 w-full max-w-sm text-center rounded-lg relative overflow-hidden">
            <div class="absolute inset-0 bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.25)_50%),linear-gradient(90deg,rgba(255,0,0,0.06),rgba(255,0,0,0.02),rgba(255,0,0,0.06))] bg-[length:100%_4px,3px_100%] pointer-events-none"></div>
            
            <h2 class="text-4xl text-red-500 mb-4 font-black tracking-tighter warning-blink">âš  ê²½ ê³  âš </h2>
            <p class="text-white text-lg font-mono mb-2">ì‹œìŠ¤í…œ í•´í‚¹ë¨</p>
            <p class="text-red-300 text-sm font-mono mb-6 border-y border-red-800 py-2 leading-relaxed">
                ì¡°ì‘í‚¤ê°€ ë°˜ì „ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
                (ìœ„ì¹˜ê°€ ì„œë¡œ ë°”ë€ë‹ˆë‹¤!)<br>
                <span class="text-green-400 block mt-2 font-bold">ì—ë„ˆì§€ ì¶©ì „ ì™„ë£Œ.</span>
            </p>
            
            <button id="resumeBtn" class="w-full bg-red-900 hover:bg-red-800 text-white font-bold py-4 rounded border border-red-500 shadow-[0_0_15px_rgba(255,0,0,0.4)] transition font-mono tracking-widest text-xl">
                ìˆ˜ë™ ì œì–´ ì‹œì‘
            </button>
        </div>
    </div>

    <!-- í—¬ ëª¨ë“œ ëª¨ë‹¬ -->
    <div id="hellModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-purple-900/40 backdrop-blur-sm interactive px-4 hidden">
        <div class="military-panel-purple p-6 w-full max-w-sm text-center rounded-lg relative overflow-hidden">
            <h2 class="text-4xl text-purple-400 mb-4 font-black tracking-tighter hell-blink">âš  ì§€ì˜¥ ëª¨ë“œ âš </h2>
            <p class="text-white text-lg font-mono mb-2">ê³„ê¸°íŒ ì˜¤ì‘ë™</p>
            <p class="text-purple-300 text-sm font-mono mb-6 border-y border-purple-800 py-2 leading-relaxed">
                ë²„íŠ¼ì´ ì œë©‹ëŒ€ë¡œ ì´ë™í•©ë‹ˆë‹¤!<br>
                ëˆˆì„ í¬ê²Œ ëœ¨ê³  í™•ì¸í•˜ì‹­ì‹œì˜¤.<br>
                <span class="text-green-400 block mt-2 font-bold">ì—ë„ˆì§€ ì¶©ì „ ì™„ë£Œ.</span>
            </p>
            
            <button id="hellResumeBtn" class="w-full bg-purple-900 hover:bg-purple-800 text-white font-bold py-4 rounded border border-purple-500 shadow-[0_0_15px_rgba(128,0,128,0.4)] transition font-mono tracking-widest text-xl">
                ìƒì¡´í•˜ë¼
            </button>
        </div>
    </div>

    <!-- ë¯¸ì…˜ ì™„ë£Œ ëª¨ë‹¬ -->
    <div id="confirmSecretModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md interactive px-4 hidden">
        <div class="military-panel-gold p-6 w-full max-w-sm text-center rounded-lg relative overflow-hidden">
            <h2 class="text-4xl text-yellow-400 mb-4 font-black tracking-tighter">ì‘ì „ ì„±ê³µ</h2>
            <p class="text-white text-md font-mono mb-6 leading-relaxed break-keep">
                ì¶•í•˜í•©ë‹ˆë‹¤, ì‚¬ë ¹ê´€ë‹˜.<br>
                ëª¨ë“  ì‹œë ¨ì„ í†µê³¼í•˜ê³  ì‚´ì•„ë‚¨ìœ¼ì…¨ìŠµë‹ˆë‹¤.<br><br>
                ì´ì œ 1ê¸‰ ê¸°ë°€ì¸<br>
                <span class="text-yellow-300 font-bold">'ë¬´í•œì˜ ê³„ë‹¨ ê³ ìˆ˜ ë¹„ë²•'</span>ì„<br>
                ì—´ëŒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?
            </p>
            
            <button id="revealSecretBtn" class="w-full bg-yellow-700 hover:bg-yellow-600 text-white font-bold py-4 rounded border border-yellow-400 shadow-[0_0_20px_rgba(236,201,75,0.5)] transition font-mono tracking-widest text-xl animate-pulse">
                ë¹„ê¸‰ ì „ìˆ˜ë°›ê¸°
            </button>
        </div>
    </div>

    <!-- ìµœì¢… ë¹„ê²° ëª¨ë‹¬ -->
    <div id="victoryModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-yellow-900/40 backdrop-blur-md interactive px-4 hidden">
        <div class="military-panel p-6 w-full max-w-sm text-center rounded-lg border-yellow-500">
            <h2 class="text-4xl text-yellow-400 mb-4 font-black tracking-tighter">ì„ë¬´ ì™„ìˆ˜</h2>
            <p class="text-gray-300 text-sm font-mono mb-4">ë¹„ë°€ íŒŒì¼ í•´ë… ì™„ë£Œ.</p>
            
            <div class="bg-black/60 p-6 border border-yellow-700 rounded mb-6">
                <h3 class="text-yellow-500 text-lg mb-2 font-bold">[ì „ì„¤ì˜ ë¹„ê²°]</h3>
                <p class="text-white font-mono text-2xl leading-relaxed break-keep">
                    "ê·¸ëƒ¥ ë§ì´ í•˜ë©´ ëŠ¡ë‹ˆë‹¤."
                </p>
            </div>
            
            <button id="victoryRestartBtn" class="w-full bg-yellow-800 hover:bg-yellow-700 text-white font-bold py-3 rounded border border-yellow-500 shadow-lg font-mono">
                íƒ€ì´í‹€ë¡œ ë³µê·€
            </button>
        </div>
    </div>

    <!-- ê²Œì„ ì˜¤ë²„ ëª¨ë‹¬ -->
    <div id="gameOverModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-red-900/20 backdrop-blur-md interactive px-4 hidden">
        <div class="military-panel p-6 w-full max-w-sm text-center border-red-900/50">
            <h2 class="text-4xl text-red-500 mb-2 font-black tracking-tighter">ì‘ì „ ì‹¤íŒ¨</h2>
            <p class="text-gray-400 text-xs mb-4 uppercase">ì„ë¬´ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</p>
            
            <div class="text-6xl mb-6 text-white hud-text" id="finalScore">0</div>
            
            <div class="bg-black/40 rounded p-4 w-full mb-6 border border-gray-700 max-h-48 overflow-y-auto">
                <h3 class="text-left text-xs text-gray-500 mb-2 border-b border-gray-800 pb-1 uppercase">ìµœì •ì˜ˆ íŒŒì¼ëŸ¿ (Top Aces)</h3>
                <div id="leaderboardList" class="space-y-1 text-sm font-mono">
                </div>
            </div>

            <div class="flex gap-2">
                <button id="homeBtn" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 rounded border border-gray-400 shadow-lg font-mono">
                    í™ˆìœ¼ë¡œ
                </button>
                <button id="restartBtn" class="flex-1 bg-red-800 hover:bg-red-700 text-white font-bold py-3 rounded border border-red-600 shadow-lg font-mono">
                    ì¬ë„ì „
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Firebase SDK -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Firebase Setup ---
    const firebaseConfig = {
        apiKey: "AIzaSyAeSmWC9q32i9Px_hljTKvewql6At5v8MU",
        authDomain: "infinite-effect.firebaseapp.com",
        projectId: "infinite-effect",
        storageBucket: "infinite-effect.firebasestorage.app",
        messagingSenderId: "139050145632",
        appId: "1:139050145632:web:dd1aa18e89aa4c6091b005"
    };
    
    // Fallback if needed, but primary config is set above.
    const appId = "infinite-effect";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    let currentUser = null;
    let unsubscribeLeaderboard = null;

    async function initFirebase() {
        try {
            await signInAnonymously(auth);
        } catch (error) {
            console.error("Auth Error:", error);
        }
    }

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            loadLeaderboard();
        }
    });

    initFirebase();

    // --- Game Logic ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const snowCanvas = document.getElementById('snow-canvas');
    const snowCtx = snowCanvas.getContext('2d');
    const gameContainer = document.getElementById('game-container');
    
    // UI Elements
    const startModal = document.getElementById('startModal');
    const gameOverModal = document.getElementById('gameOverModal');
    const rankingModal = document.getElementById('rankingModal');
    const warningModal = document.getElementById('warningModal');
    const hellModal = document.getElementById('hellModal');
    const confirmSecretModal = document.getElementById('confirmSecretModal');
    const victoryModal = document.getElementById('victoryModal');
    const shuffleAlert = document.getElementById('shuffleAlert');
    
    const startBtn = document.getElementById('startBtn');
    const rankBtn = document.getElementById('rankBtn');
    const closeRankBtn = document.getElementById('closeRankBtn');
    const restartBtn = document.getElementById('restartBtn');
    const homeBtn = document.getElementById('homeBtn');
    const resumeBtn = document.getElementById('resumeBtn');
    const hellResumeBtn = document.getElementById('hellResumeBtn');
    const revealSecretBtn = document.getElementById('revealSecretBtn');
    const victoryRestartBtn = document.getElementById('victoryRestartBtn');
    
    const scoreDisplay = document.getElementById('scoreDisplay');
    const bestDisplay = document.getElementById('bestDisplay');
    const energyBar = document.getElementById('energyBar');
    const usernameInput = document.getElementById('usernameInput');
    const finalScoreDisplay = document.getElementById('finalScore');
    const leaderboardList = document.getElementById('leaderboardList');
    const mainLeaderboardList = document.getElementById('mainLeaderboardList');
    const inGameRankList = document.getElementById('inGameRankList');
    const statusText = document.getElementById('statusText');
    const statusPanel = document.getElementById('statusPanel');
    const secretTrigger = document.getElementById('secretTrigger');
    
    // Buttons
    const controlsDiv = document.querySelector('.controls');
    const btnTurn = document.getElementById('btnTurn');
    const btnClimb = document.getElementById('btnClimb');

    // Constants
    const BLOCK_SIZE_W = 70;
    const BLOCK_SIZE_H = 25; 
    const SPACING_X = 85; 
    const SPACING_Y = 55;
    const MAX_ENERGY = 100;
    const MAX_SCORE = 1000;
    
    // Game State
    let gameState = 'MENU';
    let score = 0;
    let energy = MAX_ENERGY;
    let energyDrainRate = 0.3;
    let stairs = []; 
    let playerIndex = 0; 
    let playerFacing = 1; 
    let bestScore = 0;
    
    let isReverseMode = false;
    let isHellMode = false;
    let lastShuffleTime = 0;
    
    // Snow
    let snowflakes = [];
    const MAX_SNOWFLAKES = 150;
    let shakeIntensity = 0;
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;

        if (type === 'move') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(60, now);
            osc.frequency.exponentialRampToValueAtTime(30, now + 0.2);
            gain.gain.setValueAtTime(0.3, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.2);
            osc.start();
            osc.stop(now + 0.2);
        } else if (type === 'error') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(100, now);
            osc.frequency.exponentialRampToValueAtTime(10, now + 0.5);
            gain.gain.setValueAtTime(0.5, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
            osc.start();
            osc.stop(now + 0.5);
        } else if (type === 'alarm') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(800, now);
            osc.frequency.linearRampToValueAtTime(400, now + 0.5);
            gain.gain.setValueAtTime(0.3, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.5);
            osc.start();
            osc.stop(now + 0.5);
        }
    }

    // High DPI Handling
    function resize() {
        const dpr = window.devicePixelRatio || 1;
        canvas.style.width = window.innerWidth + 'px';
        canvas.style.height = window.innerHeight + 'px';
        snowCanvas.style.width = window.innerWidth + 'px';
        snowCanvas.style.height = window.innerHeight + 'px';
        canvas.width = window.innerWidth * dpr;
        canvas.height = window.innerHeight * dpr;
        snowCanvas.width = window.innerWidth * dpr;
        snowCanvas.height = window.innerHeight * dpr;
        ctx.setTransform(1, 0, 0, 1, 0, 0); 
        ctx.scale(dpr, dpr);
        snowCtx.setTransform(1, 0, 0, 1, 0, 0);
        snowCtx.scale(dpr, dpr);
    }
    window.addEventListener('resize', resize);
    
    // --- Snow ---
    function initSnow() {
        snowflakes = [];
        for(let i=0; i<MAX_SNOWFLAKES; i++) {
            snowflakes.push({
                x: Math.random() * window.innerWidth,
                y: Math.random() * window.innerHeight,
                r: Math.random() * 2 + 1,
                d: Math.random() * MAX_SNOWFLAKES,
                vx: Math.random() * 1 - 0.5,
                vy: Math.random() * 2 + 1
            });
        }
    }

    function updateSnow() {
        snowCtx.clearRect(0, 0, window.innerWidth, window.innerHeight);
        snowCtx.fillStyle = "rgba(255, 255, 255, 0.7)";
        snowCtx.beginPath();
        for(let i=0; i<MAX_SNOWFLAKES; i++) {
            let p = snowflakes[i];
            snowCtx.moveTo(p.x, p.y);
            snowCtx.arc(p.x, p.y, p.r, 0, Math.PI*2, true);
            p.y += p.vy;
            p.x += p.vx + Math.sin(Date.now() * 0.001 + p.d) * 0.5;
            if(p.y > window.innerHeight) {
                p.y = -10;
                p.x = Math.random() * window.innerWidth;
            }
        }
        snowCtx.fill();
    }

    // --- Debug ---
    let secretClickCount = 0;
    let secretTimer;

    secretTrigger.addEventListener('click', (e) => {
        e.preventDefault();
        secretClickCount++;
        clearTimeout(secretTimer);
        secretTimer = setTimeout(() => { secretClickCount = 0; }, 500);
        if (secretClickCount >= 3) {
            secretClickCount = 0;
            activateCheat();
        }
    });

    function activateCheat() {
        let prevScore = score;
        if (score < 499) {
            score = 499;
            energyDrainRate = 1.0;
        } else if (score < 749) {
            score = 749;
            energyDrainRate = 1.2;
        } else if (score < 999) {
            score = 999;
            energyDrainRate = 1.3;
        }
        if (prevScore !== score) {
            scoreDisplay.textContent = score;
            scoreDisplay.style.color = '#4ade80';
            setTimeout(() => { scoreDisplay.style.color = 'white'; }, 300);
            energy = MAX_ENERGY;
            energyBar.style.width = '100%';
        }
    }

    // --- Game Initialization Logic ---
    function initializeStairs() {
        stairs = [];
        let currentDir = 1; 
        for(let i=0; i<5; i++) stairs.push(1);
        for(let i=0; i<50; i++) {
            if(Math.random() < 0.3) currentDir *= -1;
            stairs.push(currentDir);
        }
        playerIndex = 0;
        playerFacing = 1;
    }

    function validateAndStartGame() {
        const name = usernameInput.value.trim();
        if (!name) {
            usernameInput.classList.add('input-error');
            setTimeout(() => usernameInput.classList.remove('input-error'), 300);
            return;
        }
        initGame();
    }

    function initGame() {
        score = 0;
        energy = MAX_ENERGY;
        energyDrainRate = 0.3;
        shakeIntensity = 0;
        isReverseMode = false;
        isHellMode = false;
        secretClickCount = 0;
        
        statusText.textContent = "ì •ìƒ ëª¨ë“œ";
        statusText.className = "text-xs text-green-400 font-mono tracking-widest";
        statusPanel.className = "military-panel p-2 rounded px-4";
        scoreDisplay.textContent = score;
        scoreDisplay.style.color = 'white';
        shuffleAlert.style.opacity = '0';
        
        if (controlsDiv.children[0] !== btnTurn) {
            controlsDiv.insertBefore(btnTurn, btnClimb);
        }
        
        gameContainer.classList.remove('whiteout-effect');
        canvas.style.transform = 'rotate(0deg)';
        
        initializeStairs();
        gameState = 'PLAYING';
        
        startModal.classList.add('hidden');
        rankingModal.classList.add('hidden');
        gameOverModal.classList.add('hidden');
        warningModal.classList.add('hidden');
        hellModal.classList.add('hidden');
        confirmSecretModal.classList.add('hidden');
        victoryModal.classList.add('hidden');
    }

    function goToHome() {
        gameState = 'MENU';
        gameOverModal.classList.add('hidden');
        victoryModal.classList.add('hidden');
        startModal.classList.remove('hidden');
        gameContainer.classList.remove('whiteout-effect');
        canvas.style.transform = 'rotate(0deg)';
        energyBar.style.width = '100%';
        score = 0;
        scoreDisplay.textContent = 0;
        initializeStairs(); 
        if (controlsDiv.children[0] !== btnTurn) {
            controlsDiv.insertBefore(btnTurn, btnClimb);
        }
    }

    function showRankings() { rankingModal.classList.remove('hidden'); }
    function hideRankings() { rankingModal.classList.add('hidden'); }

    function triggerReverseMode() {
        gameState = 'PAUSED';
        playSound('alarm');
        warningModal.classList.remove('hidden');
        isReverseMode = true;
        energy = MAX_ENERGY;
        energyBar.style.width = '100%';
        controlsDiv.insertBefore(btnClimb, btnTurn);
        statusText.textContent = "âš  ë°˜ì „ ëª¨ë“œ âš ";
        statusText.className = "text-xs text-red-500 font-mono tracking-widest warning-blink";
        statusPanel.className = "military-panel-red p-2 rounded px-4";
    }

    function triggerHellMode() {
        gameState = 'PAUSED';
        playSound('alarm');
        hellModal.classList.remove('hidden');
        isHellMode = true;
        isReverseMode = false;
        lastShuffleTime = Date.now();
        if (controlsDiv.children[0] !== btnTurn) {
            controlsDiv.insertBefore(btnTurn, btnClimb);
        }
        energy = MAX_ENERGY;
        energyBar.style.width = '100%';
        statusText.textContent = "âš  ì¹´ë©œë ˆì˜¨ âš ";
        statusText.className = "text-xs text-purple-400 font-mono tracking-widest hell-blink";
        statusPanel.className = "military-panel-purple p-2 rounded px-4";
    }

    function resumeGame() {
        gameState = 'PLAYING';
        warningModal.classList.add('hidden');
        hellModal.classList.add('hidden');
    }
    
    function triggerConfirmSecret() {
        gameState = 'GAMEOVER'; 
        saveScore(score); 
        confirmSecretModal.classList.remove('hidden');
    }

    function revealSecret() {
        confirmSecretModal.classList.add('hidden');
        victoryModal.classList.remove('hidden');
    }

    function generateStairs() {
        while (stairs.length < playerIndex + 50) {
            let lastDir = stairs[stairs.length - 1];
            let switchChance = Math.min(0.3 + (score * 0.001), 0.6);
            let nextDir = Math.random() < switchChance ? lastDir * -1 : lastDir;
            stairs.push(nextDir);
        }
    }

    function checkMove(action) {
        if (gameState !== 'PLAYING') return;

        if (score === 500 && !isReverseMode && !isHellMode) {
            triggerReverseMode();
            return;
        }
        if (score === 750 && !isHellMode) {
            triggerHellMode();
            return;
        }

        let intendedDirection = playerFacing;
        let actualAction = action;
        if (actualAction === 'TURN') intendedDirection *= -1;
        
        let nextStairDirection = stairs[playerIndex + 1];
        
        if (intendedDirection === nextStairDirection) {
            playerIndex++;
            playerFacing = intendedDirection;
            score++;
            scoreDisplay.textContent = score;
            playSound('move');
            shakeIntensity = 3; 
            
            energy += 12; 
            if (energy > MAX_ENERGY) energy = MAX_ENERGY;
            
            energyDrainRate = Math.min(0.3 + (score * 0.0012), 1.5);
            if (isHellMode) energyDrainRate = 1.2;

            if (score >= 1000) {
                triggerConfirmSecret();
                return;
            }
            generateStairs();
        } else {
            shakeIntensity = 10;
            gameOver();
        }
    }

    function gameOver() {
        playSound('error');
        gameState = 'GAMEOVER';
        
        if(finalScoreDisplay) finalScoreDisplay.textContent = score;
        
        if (score > bestScore) {
            bestScore = score;
            if(bestDisplay) bestDisplay.textContent = bestScore;
        }
        
        saveScore(score);
        
        if(gameOverModal) gameOverModal.classList.remove('hidden');
    }

    function update() {
        if (gameState !== 'PLAYING') return;
        energy -= energyDrainRate;
        if(energyBar) energyBar.style.width = `${Math.max(0, (energy / MAX_ENERGY) * 100)}%`;
        
        if (energy <= 0) {
            gameOver();
            return;
        }
        
        if (shakeIntensity > 0) shakeIntensity *= 0.9;
        
        if (isHellMode) {
            if (Date.now() - lastShuffleTime > 3000) {
                lastShuffleTime = Date.now();
                if (controlsDiv.children[0] === btnTurn) {
                    controlsDiv.insertBefore(btnClimb, btnTurn);
                } else {
                    controlsDiv.insertBefore(btnTurn, btnClimb);
                }
                shuffleAlert.style.opacity = '1';
                setTimeout(() => { shuffleAlert.style.opacity = '0'; }, 1000);
            }
        }
    }

    // --- Drawing ---
    function drawBackground(ctx) {
        const gradient = ctx.createLinearGradient(0, 0, 0, window.innerHeight);
        if (isHellMode) {
            gradient.addColorStop(0, '#2d3748'); 
            gradient.addColorStop(1, '#553c9a');
        } else if (isReverseMode) {
            gradient.addColorStop(0, '#2c0b0e'); 
            gradient.addColorStop(1, '#4a1010');
        } else {
            gradient.addColorStop(0, '#757f9a'); 
            gradient.addColorStop(1, '#d7dde8');
        }
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, window.innerWidth, window.innerHeight);
        
        ctx.save();
        ctx.fillStyle = '#4a5568'; 
        for(let i=0; i<10; i++) {
            let x = (i * 150) - (playerIndex * 20) % 1500; 
            let h = 100 + Math.random() * 50;
            let y = window.innerHeight - 150; 
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x + 10, y - h);
            ctx.lineTo(x + 20, y);
            ctx.fill();
        }
        ctx.fillStyle = '#cbd5e0';
        ctx.fillRect(0, window.innerHeight - 150, window.innerWidth, 150);
        ctx.restore();
    }

    function drawTank(ctx, x, y, facing) {
        const scale = 0.8;
        ctx.save();
        ctx.translate(x, y - 10);
        ctx.scale(facing * scale, scale); 
        
        const camoGreen = '#4B5320'; 
        const camoWhite = '#F0F0F0'; 
        const trackColor = '#1a202c'; 
        const wheelColor = '#2d3748';
        
        ctx.fillStyle = trackColor;
        ctx.fillRect(-25, 10, 50, 12);
        
        ctx.fillStyle = wheelColor;
        for(let i=0; i<4; i++) {
            ctx.beginPath();
            ctx.arc(-18 + (i * 12), 16, 5, 0, Math.PI*2);
            ctx.fill();
        }

        ctx.beginPath();
        ctx.moveTo(-25, 10);
        ctx.lineTo(25, 10); 
        ctx.lineTo(30, 0);  
        ctx.lineTo(15, -8); 
        ctx.lineTo(-25, -8); 
        ctx.lineTo(-28, 0); 
        ctx.closePath();
        ctx.fillStyle = camoGreen;
        ctx.fill();
        
        ctx.fillStyle = camoWhite;
        ctx.beginPath();
        ctx.moveTo(-10, 10);
        ctx.lineTo(10, 10);
        ctx.lineTo(5, 0);
        ctx.fill();
        ctx.fillStyle = '#222';
        ctx.fillRect(-20, -6, 10, 4);

        ctx.beginPath();
        ctx.arc(0, -8, 14, Math.PI, 0); 
        ctx.lineTo(10, -5);
        ctx.lineTo(-10, -5);
        ctx.closePath();
        ctx.fillStyle = camoGreen;
        ctx.fill();
        
        ctx.fillStyle = camoWhite;
        ctx.beginPath();
        ctx.arc(-5, -12, 5, 0, Math.PI*2);
        ctx.fill();

        ctx.fillStyle = '#2F3530'; 
        ctx.fillRect(10, -12, 35, 6); 
        ctx.fillStyle = '#111';
        ctx.fillRect(40, -14, 5, 10);

        ctx.fillStyle = '#c53030';
        ctx.beginPath();
        ctx.arc(0, -8, 3, 0, Math.PI*2);
        ctx.fill();
        ctx.restore();
    }

    function drawSnowyBlock(ctx, x, y, isCurrent) {
        const w = BLOCK_SIZE_W;
        const h = 25; 
        const depth = 35; 

        let earthTop = '#4a5568';
        let earthBot = '#2d3748';
        if (isReverseMode) {
            earthTop = '#3b1010'; 
            earthBot = '#1a0505';
        }

        const earthGradient = ctx.createLinearGradient(x, y + h, x, y + h + depth);
        earthGradient.addColorStop(0, earthTop); 
        earthGradient.addColorStop(1, earthBot); 
        
        ctx.fillStyle = earthGradient;
        ctx.beginPath();
        ctx.moveTo(x - w/2 + 2, y + h); 
        ctx.lineTo(x + w/2 - 2, y + h);
        ctx.lineTo(x + w/2, y + h + depth);
        ctx.lineTo(x - w/2, y + h + depth);
        ctx.closePath();
        ctx.fill();

        ctx.fillStyle = '#1a202c';
        ctx.fillRect(x - 10, y + h + 10, 5, 5);
        ctx.fillRect(x + 15, y + h + 20, 4, 3);

        ctx.fillStyle = '#f7fafc'; 
        ctx.beginPath();
        ctx.moveTo(x - w/2, y);
        ctx.lineTo(x + w/2, y);
        ctx.lineTo(x + w/2, y + h);
        ctx.lineTo(x + w/4, y + h + 3); 
        ctx.lineTo(x, y + h - 2); 
        ctx.lineTo(x - w/4, y + h + 3); 
        ctx.lineTo(x - w/2, y + h);
        ctx.closePath();
        ctx.fill();

        ctx.fillStyle = '#ffffff';
        ctx.fillRect(x - w/2 + 5, y + 2, w - 10, 5);
        
        if (!isCurrent) {
            ctx.fillStyle = 'rgba(0,0,0,0.1)';
            ctx.fillRect(x - w/2, y, w, h);
        }
    }

    function draw() {
        if (!stairs || stairs.length === 0) return;

        ctx.save();
        let dx = (Math.random() - 0.5) * shakeIntensity;
        let dy = (Math.random() - 0.5) * shakeIntensity;
        ctx.translate(dx, dy);
        
        drawBackground(ctx);
        
        const centerX = window.innerWidth / 2;
        const centerY = window.innerHeight * 0.7;
        ctx.translate(centerX, centerY);
        
        function getOffset(targetI) {
            let dx = 0;
            let dy = 0;
            if (targetI === playerIndex) return {x:0, y:0};
            if (targetI > playerIndex) {
                for(let k=playerIndex + 1; k<=targetI; k++) {
                    let dir = stairs[k];
                    dx += (dir * SPACING_X); 
                    dy -= SPACING_Y; 
                }
            } else {
                for(let k=playerIndex; k > targetI; k--) {
                    let dir = stairs[k];
                    dx -= (dir * SPACING_X);
                    dy += SPACING_Y;
                }
            }
            return {x: dx, y: dy};
        }
        
        for (let i = playerIndex + 12; i >= Math.max(0, playerIndex - 3); i--) {
            let pos = getOffset(i);
            drawSnowyBlock(ctx, pos.x, pos.y, i === playerIndex);
        }
        drawTank(ctx, 0, 0, playerFacing);
        ctx.restore();
    }

    function gameLoop() {
        if (gameState === 'PLAYING') {
            update();
        }
        draw();
        updateSnow();
        requestAnimationFrame(gameLoop);
    }

    // --- Input ---
    function handleInput(type) {
        if (gameState === 'MENU') return;
        if (gameState === 'PLAYING') checkMove(type);
    }

    window.addEventListener('keydown', (e) => {
        if (gameState !== 'PLAYING') return;
        
        if (e.code === 'KeyZ') {
            if (isReverseMode) {
                handleInput('CLIMB');
            } else {
                if (isHellMode && controlsDiv.children[0] === btnClimb) {
                    handleInput('CLIMB');
                } else {
                    handleInput('TURN');
                }
            }
        }
        if (e.code === 'KeyX') {
            if (isReverseMode) {
                handleInput('TURN');
            } else {
                if (isHellMode && controlsDiv.children[1] === btnTurn) {
                    handleInput('TURN');
                } else {
                    handleInput('CLIMB');
                }
            }
        }
    });

    btnTurn.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput('TURN'); });
    btnTurn.addEventListener('mousedown', (e) => { e.preventDefault(); handleInput('TURN'); });
    btnClimb.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput('CLIMB'); });
    btnClimb.addEventListener('mousedown', (e) => { e.preventDefault(); handleInput('CLIMB'); });

    startBtn.addEventListener('click', validateAndStartGame);
    restartBtn.addEventListener('click', initGame);
    homeBtn.addEventListener('click', goToHome);
    rankBtn.addEventListener('click', showRankings);
    closeRankBtn.addEventListener('click', hideRankings);
    resumeBtn.addEventListener('click', resumeGame);
    hellResumeBtn.addEventListener('click', resumeGame);
    revealSecretBtn.addEventListener('click', revealSecret);
    victoryRestartBtn.addEventListener('click', goToHome);

    // --- Firebase ---
    function getCollectionPath() {
        // Always use consistent collection name
        return collection(db, 'infinite_tank_scores'); 
    }

    async function saveScore(finalScore) {
        if (!currentUser) return;
        if (finalScore === 0) return;
        const name = usernameInput.value || 'Soldier';
        try {
            await addDoc(getCollectionPath(), {
                name: name,
                score: finalScore,
                userId: currentUser.uid,
                timestamp: serverTimestamp()
            });
        } catch (e) {
            console.error("Save Error:", e);
        }
    }

    function loadLeaderboard() {
        if (!currentUser) return;
        if (unsubscribeLeaderboard) unsubscribeLeaderboard();
        const q = query(getCollectionPath());
        unsubscribeLeaderboard = onSnapshot(q, (snapshot) => {
            const scores = [];
            snapshot.forEach((doc) => scores.push(doc.data()));
            scores.sort((a, b) => b.score - a.score);
            const top10 = scores.slice(0, 10);
            
            const renderList = (listElement) => {
                if (!listElement) return;
                listElement.innerHTML = '';
                if (top10.length === 0) {
                    listElement.innerHTML = '<div class="text-center text-gray-500 mt-2">ê¸°ë¡ ì—†ìŒ</div>';
                    return;
                }
                top10.forEach((item, index) => {
                    const isMe = item.userId === currentUser.uid && item.score === score && score > 0;
                    const div = document.createElement('div');
                    div.className = `flex justify-between items-center p-2 rounded ${index === 0 ? 'bg-yellow-900/40 text-yellow-200 border border-yellow-700' : 'bg-gray-800'} ${isMe ? 'border border-green-500' : ''}`;
                    div.innerHTML = `<span class="w-8 font-bold text-gray-400">${index + 1}.</span><span class="flex-1 truncate mx-2 text-white">${item.name}</span><span class="font-mono text-yellow-400 font-bold">${item.score}</span>`;
                    listElement.appendChild(div);
                });
            };
            
            renderList(leaderboardList);
            renderList(mainLeaderboardList);
            
            const top3 = scores.slice(0, 3);
            if(inGameRankList) {
                inGameRankList.innerHTML = '';
                top3.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = "flex justify-between text-[10px]";
                    div.innerHTML = `<span>${index+1}. ${item.name}</span><span class="text-yellow-400">${item.score}</span>`;
                    inGameRankList.appendChild(div);
                });
            }

        }, (error) => {
            console.error("Leaderboard Error:", error);
            const errorMsg = '<div class="text-center text-red-400 text-xs mt-4">ë­í‚¹ ë¡œë“œ ì‹¤íŒ¨<br>ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”</div>';
            if(leaderboardList) leaderboardList.innerHTML = errorMsg;
            if(mainLeaderboardList) mainLeaderboardList.innerHTML = errorMsg;
        });
    }
    
    // Init on load
    resize();
    initSnow();
    initializeStairs(); 
    requestAnimationFrame(gameLoop);

</script>
</body>
</html>
